/*! snake 2014-01-08 */
!function(){function a(a){var c=!1;return function(){if(c)throw new Error("Callback was already called.");c=!0,a.apply(b,arguments)}}var b,c,d={};b=this,null!=b&&(c=b.async),d.noConflict=function(){return b.async=c,d};var e=function(a,b){if(a.forEach)return a.forEach(b);for(var c=0;c<a.length;c+=1)b(a[c],c,a)},f=function(a,b){if(a.map)return a.map(b);var c=[];return e(a,function(a,d,e){c.push(b(a,d,e))}),c},g=function(a,b,c){return a.reduce?a.reduce(b,c):(e(a,function(a,d,e){c=b(c,a,d,e)}),c)},h=function(a){if(Object.keys)return Object.keys(a);var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b};d.nextTick="undefined"!=typeof process&&process.nextTick?process.nextTick:"function"==typeof setImmediate?function(a){setImmediate(a)}:function(a){setTimeout(a,0)},d.each=function(b,c,d){if(d=d||function(){},!b.length)return d();var f=0;e(b,function(e){c(e,a(function(a){a?(d(a),d=function(){}):(f+=1,f>=b.length&&d(null))}))})},d.forEach=d.each,d.eachSeries=function(a,b,c){if(c=c||function(){},!a.length)return c();var e=0,f=function(){var g=!0;b(a[e],function(b){b?(c(b),c=function(){}):(e+=1,e>=a.length?c(null):g?d.nextTick(f):f())}),g=!1};f()},d.forEachSeries=d.eachSeries,d.eachLimit=function(a,b,c,d){var e=i(b);e.apply(null,[a,c,d])},d.forEachLimit=d.eachLimit;var i=function(a){return function(b,c,d){if(d=d||function(){},!b.length||0>=a)return d();var e=0,f=0,g=0;!function h(){if(e>=b.length)return d();for(;a>g&&f<b.length;)f+=1,g+=1,c(b[f-1],function(a){a?(d(a),d=function(){}):(e+=1,g-=1,e>=b.length?d():h())})}()}},j=function(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[d.each].concat(b))}},k=function(a,b){return function(){var c=Array.prototype.slice.call(arguments);return b.apply(null,[i(a)].concat(c))}},l=function(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[d.eachSeries].concat(b))}},m=function(a,b,c,d){var e=[];b=f(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c,d){e[a.index]=d,b(c)})},function(a){d(a,e)})};d.map=j(m),d.mapSeries=l(m),d.mapLimit=function(a,b,c,d){return n(b)(a,c,d)};var n=function(a){return k(a,m)};d.reduce=function(a,b,c,e){d.eachSeries(a,function(a,d){c(b,a,function(a,c){b=c,d(a)})},function(a){e(a,b)})},d.inject=d.reduce,d.foldl=d.reduce,d.reduceRight=function(a,b,c,e){var g=f(a,function(a){return a}).reverse();d.reduce(g,b,c,e)},d.foldr=d.reduceRight;var o=function(a,b,c,d){var e=[];b=f(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c&&e.push(a),b()})},function(){d(f(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};d.filter=j(o),d.filterSeries=l(o),d.select=d.filter,d.selectSeries=d.filterSeries;var p=function(a,b,c,d){var e=[];b=f(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c||e.push(a),b()})},function(){d(f(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};d.reject=j(p),d.rejectSeries=l(p);var q=function(a,b,c,d){a(b,function(a,b){c(a,function(c){c?(d(a),d=function(){}):b()})},function(){d()})};d.detect=j(q),d.detectSeries=l(q),d.some=function(a,b,c){d.each(a,function(a,d){b(a,function(a){a&&(c(!0),c=function(){}),d()})},function(){c(!1)})},d.any=d.some,d.every=function(a,b,c){d.each(a,function(a,d){b(a,function(a){a||(c(!1),c=function(){}),d()})},function(){c(!0)})},d.all=d.every,d.sortBy=function(a,b,c){d.map(a,function(a,c){b(a,function(b,d){b?c(b):c(null,{value:a,criteria:d})})},function(a,b){if(a)return c(a);var d=function(a,b){var c=a.criteria,d=b.criteria;return d>c?-1:c>d?1:0};c(null,f(b.sort(d),function(a){return a.value}))})},d.auto=function(a,b){b=b||function(){};var c=h(a);if(!c.length)return b(null);var f={},i=[],j=function(a){i.unshift(a)},k=function(a){for(var b=0;b<i.length;b+=1)if(i[b]===a)return i.splice(b,1),void 0},l=function(){e(i.slice(0),function(a){a()})};j(function(){h(f).length===c.length&&(b(null,f),b=function(){})}),e(c,function(c){var e=a[c]instanceof Function?[a[c]]:a[c],h=function(a){if(a)b(a),b=function(){};else{var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),f[c]=e,d.nextTick(l)}},i=e.slice(0,Math.abs(e.length-1))||[],m=function(){return g(i,function(a,b){return a&&f.hasOwnProperty(b)},!0)&&!f.hasOwnProperty(c)};if(m())e[e.length-1](h,f);else{var n=function(){m()&&(k(n),e[e.length-1](h,f))};j(n)}})},d.waterfall=function(a,b){if(b=b||function(){},!a.length)return b();var c=function(a){return function(e){if(e)b.apply(null,arguments),b=function(){};else{var f=Array.prototype.slice.call(arguments,1),g=a.next();g?f.push(c(g)):f.push(b),d.nextTick(function(){a.apply(null,f)})}}};c(d.iterator(a))()};var r=function(a,b,c){if(c=c||function(){},b.constructor===Array)a.map(b,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},c);else{var d={};a.each(h(b),function(a,c){b[a](function(b){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),d[a]=e,c(b)})},function(a){c(a,d)})}};d.parallel=function(a,b){r({map:d.map,each:d.each},a,b)},d.parallelLimit=function(a,b,c){r({map:n(b),each:i(b)},a,c)},d.series=function(a,b){if(b=b||function(){},a.constructor===Array)d.mapSeries(a,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},b);else{var c={};d.eachSeries(h(a),function(b,d){a[b](function(a){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),c[b]=e,d(a)})},function(a){b(a,c)})}},d.iterator=function(a){var b=function(c){var d=function(){return a.length&&a[c].apply(null,arguments),d.next()};return d.next=function(){return c<a.length-1?b(c+1):null},d};return b(0)},d.apply=function(a){var b=Array.prototype.slice.call(arguments,1);return function(){return a.apply(null,b.concat(Array.prototype.slice.call(arguments)))}};var s=function(a,b,c,d){var e=[];a(b,function(a,b){c(a,function(a,c){e=e.concat(c||[]),b(a)})},function(a){d(a,e)})};d.concat=j(s),d.concatSeries=l(s),d.whilst=function(a,b,c){if(a()){var e=!0;b(function(f){return f?c(f):(e?d.nextTick(function(){d.whilst(a,b,c)}):d.whilst(a,b,c),void 0)}),e=!1}else c()},d.doWhilst=function(a,b,c){var e=!0;a(function(f){return f?c(f):(b()?e?d.nextTick(function(){d.doWhilst(a,b,c)}):d.doWhilst(a,b,c):c(),void 0)}),e=!1},d.until=function(a,b,c){if(a())c();else{var e=!0;b(function(f){return f?c(f):(e?d.nextTick(function(){d.until(a,b,c)}):d.until(a,b,c),void 0)}),e=!1}},d.doUntil=function(a,b,c){var e=!0;a(function(f){return f?c(f):(b()?c():e?d.nextTick(function(){d.doUntil(a,b,c)}):d.doUntil(a,b,c),void 0)}),e=!1},d.queue=function(b,c){function f(a,b,f,g){b.constructor!==Array&&(b=[b]),e(b,function(b){var e={data:b,callback:"function"==typeof g?g:null};f?a.tasks.unshift(e):a.tasks.push(e),a.saturated&&a.tasks.length===c&&a.saturated(),d.nextTick(a.process)})}var g=0,h={tasks:[],concurrency:c,saturated:null,empty:null,drain:null,push:function(a,b){f(h,a,!1,b)},unshift:function(a,b){f(h,a,!0,b)},process:function(){if(g<h.concurrency&&h.tasks.length){var c=h.tasks.shift();h.empty&&0===h.tasks.length&&h.empty(),g+=1;var e=!0,f=function(){g-=1,c.callback&&c.callback.apply(c,arguments),h.drain&&h.tasks.length+g===0&&h.drain(),h.process()},i=a(function(){var a=arguments;e?d.nextTick(function(){f.apply(null,a)}):f.apply(null,arguments)});b(c.data,i),e=!1}},length:function(){return h.tasks.length},running:function(){return g}};return h},d.cargo=function(a,b){var c=!1,g=[],h={tasks:g,payload:b,saturated:null,empty:null,drain:null,push:function(a,c){a.constructor!==Array&&(a=[a]),e(a,function(a){g.push({data:a,callback:"function"==typeof c?c:null}),h.saturated&&g.length===b&&h.saturated()}),d.nextTick(h.process)},process:function i(){if(!c){if(0===g.length)return h.drain&&h.drain(),void 0;var d="number"==typeof b?g.splice(0,b):g.splice(0),j=f(d,function(a){return a.data});h.empty&&h.empty(),c=!0,a(j,function(){c=!1;var a=arguments;e(d,function(b){b.callback&&b.callback.apply(null,a)}),i()})}},length:function(){return g.length},running:function(){return c}};return h};var t=function(a){return function(b){var c=Array.prototype.slice.call(arguments,1);b.apply(null,c.concat([function(b){var c=Array.prototype.slice.call(arguments,1);"undefined"!=typeof console&&(b?console.error&&console.error(b):console[a]&&e(c,function(b){console[a](b)}))}]))}};d.log=t("log"),d.dir=t("dir"),d.memoize=function(a,b){var c={},d={};b=b||function(a){return a};var e=function(){var e=Array.prototype.slice.call(arguments),f=e.pop(),g=b.apply(null,e);g in c?f.apply(null,c[g]):g in d?d[g].push(f):(d[g]=[f],a.apply(null,e.concat([function(){c[g]=arguments;var a=d[g];delete d[g];for(var b=0,e=a.length;e>b;b++)a[b].apply(null,arguments)}])))};return e.memo=c,e.unmemoized=a,e},d.unmemoize=function(a){return function(){return(a.unmemoized||a).apply(null,arguments)}},d.times=function(a,b,c){for(var e=[],f=0;a>f;f++)e.push(f);return d.map(e,b,c)},d.timesSeries=function(a,b,c){for(var e=[],f=0;a>f;f++)e.push(f);return d.mapSeries(e,b,c)},d.compose=function(){var a=Array.prototype.reverse.call(arguments);return function(){var b=this,c=Array.prototype.slice.call(arguments),e=c.pop();d.reduce(a,c,function(a,c,d){c.apply(b,a.concat([function(){var a=arguments[0],b=Array.prototype.slice.call(arguments,1);d(a,b)}]))},function(a,c){e.apply(b,[a].concat(c))})}},"undefined"!=typeof define&&define.amd?define([],function(){return d}):"undefined"!=typeof module&&module.exports?module.exports=d:b.async=d}(),function(){function a(a){setTimeout(a,0)}function b(a){this.fps=w.INIT_FPS,this.tick=a,this.paused=!1}function c(a,b){this.blocks=a,this.direction=DIRECTION_LEFT,this.directionChanged=!1,this.x=Math.ceil(this.blocks/2),this.y=Math.ceil(this.blocks/2),this.sections=[];for(var c=this.x+b-1;c>=this.x;c--)this.sections.push({x:c,y:this.y})}function d(a){if(a){var e=this;this.canvas=a,this.context=this.canvas.getContext("2d"),this.blocks=d.BLOCKS,this.block_size=this.canvas.width/this.blocks,this.snake=new c(this.blocks,5),this.foods=[],this.food=this.getFood(),this.scoreListener=null,this.status=d.INITIALIZED,this.failListener=null,this.timer=new b(function(){if(e.snake.move(),e.isCollision())return e.timer.pause(),e.fail(),void 0;if(e.snake.directionChanged=!1,e.snake.x==e.food.x&&e.snake.y==e.food.y){e.foods.push(e.food),e.foods.length%5===0&&e.timer.speedUp(),z.triggerScoreChanged.call(e),e.snake.sections.push({x:e.snake.x,y:e.snake.y});var a=e.getFood();if(!a)return e.fail();e.food=a}else e.snake.sections.shift(),e.snake.sections.push({x:e.snake.x,y:e.snake.y});k(function(){e.draw()})})}}function e(a){for(var b in A){var c=A[b];if(~t.indexOf(c,a))return b}return null}function f(a){this.el=a,this.$el=$(a)}function g(a){var b=this;this.el=a,this.$el=$(a),this.$el.find(".restart").click(function(){b.onRestartHandler&&b.onRestartHandler()})}function h(){this.rounds=0,this.user=null}function i(a){var b=["images/snake.png","images/foods.png"];async.each(b,function(a,b){var c=new Image;c.onload=function(){"images/snake.png"===a?E=c:"images/foods.png"==a&&(C=c),b(null,c)},c.onerror=function(){b("fail to load image:"+a)},c.src=a},function(b,c){return b?a(b):(a(null,c),void 0)})}function j(a){async.each(["json/snake.json","json/foods.json"],function(a,b){$.get(a,"json").success(function(c){"json/snake.json"===a?F=c:D=c,b(null,c)}).error(function(){b("fail to load sprites: "+a)})},function(b,c){return b?a(b):(a(null,c),void 0)})}var k=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||a,l=Array.prototype,m=Object.prototype,n=l.slice,o=l.indexOf,p=l.forEach,q=m.hasOwnProperty,r=Object.keys,s={},t={};t.has=function(a,b){return q.call(a,b)},t.keys=r||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[];for(var c in a)t.has(a,c)&&b.push(c);return b},t.indexOf=function(a,b){if(null===a)return-1;var c=0,d=a.length;if(o&&a.indexOf===o)return a.indexOf(b);for(;d>c;c++)if(a[c]===b)return c;return-1},t.each=function(a,b,c){if(null!==a)if(p&&a.forEach===p)a.forEach(b,c);else if(a.length===+a.length){for(var d=0,e=a.length;e>d;d++)if(b.call(c,a[d],d,a)===s)return}else for(var f=t.keys(a),g=0;g<f.length;g++)if(b.call(c,a[f[g]],f[g],a)===breaker)return},t.extend=function(a){return t.each(n.call(arguments,1),function(b){if(b)for(var c in b)a[c]=b[c]}),a},t.bind=function(a,b){var c=n.call(arguments,2);return function(){a.apply(b,c.concat(n.call(arguments)))}},t.delay=function(a,b){return function(){var c=arguments;setTimeout(function(){b&&b.apply(this,c)},a)}},t.timeup=function(a,b,c){var d="doing",e="done",f="timeout",g=d;return setTimeout(function(){console.log("u.timeup onTimeup, status: ",g),g===d&&(g=f,c&&c())},a),function(){console.log("u.timeup callback, status: ",g),g===d&&(g=e,b&&b.apply(this,arguments))}},console=window.console||{},console.log=console.log||function(){},console.error=console.error||function(){};var u=function(){return u.get.apply(u,arguments)};u.utils={isArray:Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},isPlainObject:function(a){return!!a&&"[object Object]"===Object.prototype.toString.call(a)},toArray:function(a){return Array.prototype.slice.call(a)},getKeys:Object.keys||function(a){var b=[],c="";for(c in a)a.hasOwnProperty(c)&&b.push(c);return b},escape:function(a){return String(a).replace(/[,;"\\=\s%]/g,function(a){return encodeURIComponent(a)})},retrieve:function(a,b){return null==a?b:a}},u.defaults={},u.expiresMultiplier=86400,u.set=function(a,b,c){if(u.utils.isPlainObject(a))for(var d in a)a.hasOwnProperty(d)&&this.set(d,a[d],b);else{c=u.utils.isPlainObject(c)?c:{expires:c};var e=void 0!==c.expires?c.expires:this.defaults.expires||"",f=typeof e;"string"===f&&""!==e?e=new Date(e):"number"===f&&(e=new Date(+new Date+1e3*this.expiresMultiplier*e)),""!==e&&"toGMTString"in e&&(e=";expires="+e.toGMTString());var g=c.path||this.defaults.path;g=g?";path="+g:"";var h=c.domain||this.defaults.domain;h=h?";domain="+h:"";var i=c.secure||this.defaults.secure?";secure":"";document.cookie=u.utils.escape(a)+"="+u.utils.escape(b)+e+g+h+i}return this},u.remove=function(a){a=u.utils.isArray(a)?a:u.utils.toArray(arguments);for(var b=0,c=a.length;c>b;b++)this.set(a[b],"",-1);return this},u.empty=function(){return this.remove(u.utils.getKeys(this.all()))},u.get=function(a,b){b=b||void 0;var c=this.all();if(u.utils.isArray(a)){for(var d={},e=0,f=a.length;f>e;e++){var g=a[e];d[g]=u.utils.retrieve(c[g],b)}return d}return u.utils.retrieve(c[a],b)},u.all=function(){if(""===document.cookie)return{};for(var a=document.cookie.split("; "),b={},c=0,d=a.length;d>c;c++){var e=a[c].split("=");b[decodeURIComponent(e[0])]=decodeURIComponent(e[1])}return b},u.enabled=function(){if(navigator.cookieEnabled)return!0;var a="_"===u.set("_","_").get("_");return u.remove("_"),a};var v={NOT_LOGIN:"not-login",upload:function(a,b){$.get("/test/upload",a,"json").success(function(a){1!=a.status?b("error"):b(null,a.data)}).error(function(){b("network error")})},info:function(a){$.get("/test/info","json").success(function(b){1!=b.status?a("error"):a(null,b.data)}).error(function(){a("network error")})},sync_score:function(a,b){function c(b){v.upload(a,function(a,c){return a?b(a):(b(null,c.gift),void 0)})}function d(a,b){v.info(function(c,d){return c?b(c):(d.gift=a,b(null,d),void 0)})}async.waterfall([c,d],function(a,c){return a?b(a):(b(null,c),void 0)})},login:function(a){setTimeout(function(){a(null)},0)},userid:0,isUserLogined:function(){return!0}},w={INIT_FPS:4};b.prototype={constructor:b,start:function(){this.paused=!1,this.count()},count:function(){var a=this;setTimeout(function(){a.paused||(a.tick(),a.count())},1e3/this.fps)},pause:function(){this.paused=!0},speedUp:function(){this.fps<60&&this.fps++}},DIRECTION_LEFT="left",DIRECTION_RIGHT="right",DIRECTION_UP="up",DIRECTION_DOWN="down";var x={foods:{food1:{key:"food1",name:"food1"},food2:{key:"food2",name:"food2"},food3:{key:"food3",name:"food3"},food4:{key:"food4",name:"food4"},food5:{key:"food5",name:"food5"},food6:{key:"food6",name:"food6"},food7:{key:"food7",name:"food7"},food8:{key:"food8",name:"food8"},food9:{key:"food9",name:"food9"},food10:{key:"food10",name:"food10"},food11:{key:"food11",name:"food11"},food12:{key:"food12",name:"food12"},food13:{key:"food13",name:"food13"},food14:{key:"food14",name:"food14"}}},y={getFood:function(){var a=t.keys(x.foods);if(0===a.length)return null;var b=Math.floor(Math.random()*a.length);return x.foods[a[b]]}};INVERSE_DIRECTION={up:DIRECTION_DOWN,left:DIRECTION_RIGHT,right:DIRECTION_LEFT,down:DIRECTION_UP},c.prototype={section:function(a){var b=(this.sections.length+a)%this.sections.length;return this.sections[b]},length:function(){return this.sections.length},changeDirection:function(a){this.directionChanged||a!==INVERSE_DIRECTION[this.direction]&&(this.direction=a,this.directionChanged=!0)},bumpSelf:function(){return this.onBody(this.x,this.y)},onBody:function(a,b){for(var c=0;c<this.sections.length;c++){var d=this.sections[c];if(d.x===a&&d.y===b)return!0}return!1},directionOfSection:function(a){var b,c,d=this.sections.length,e=(d+a)%d;e==d-1?(b=this.section(e),c=this.section(e-1)):(c=this.section(e),b=this.section(e+1));var f;return f=b.x===c.x?b.y===c.y-1?DIRECTION_UP:DIRECTION_DOWN:b.x===c.x-1?DIRECTION_LEFT:DIRECTION_RIGHT},move:function(){switch(this.direction){case DIRECTION_UP:this.y--;break;case DIRECTION_DOWN:this.y++;break;case DIRECTION_LEFT:this.x--;break;default:this.x++}}};var z={DEFAULT_SCORE:10,triggerScoreChanged:function(){this.scoreListener&&this.scoreListener()}};t.extend(d,{BLOCKS:10,INITIALIZED:"initialized",PLAYING:"playing",PAUSED:"paused",OVER:"over"}),d.prototype={contructor:d,isInitialized:function(){return this.status===d.INITIALIZED},isOver:function(){return this.status===d.OVER},over:function(){this.status=d.OVER},start:function(){var a=this;return this.status!==d.INITIALIZED&&this.status!==d.PAUSED?(console.error("wrong status"),void 0):(this.status=d.PLAYING,this.timer.start(),k(function(){a.draw()}),void 0)},pause:function(){this.timer.pause(),this.status=d.PAUSED},fail:function(){this.status=d.OVER,this.failListener&&this.failListener()},onFailed:function(a){this.failListener=a},isCollision:function(){return this.snake.x<0||this.snake.x>=this.blocks||this.snake.y<0||this.snake.y>=this.blocks?!0:this.snake.bumpSelf()},resetCanvas:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},score:function(){var a=0;return t.each(this.foods,function(b){a+=b.score}),a},onScoreChanged:function(a){this.scoreListener=a},drawSnake:function(){this.drawSnakeHead(),this.drawSnakeBody(),this.drawSnakeTail()},drawImage:function(a,b,c){var d=this.context;d.drawImage(a,b.x,b.y,b.width,b.height,c.x,c.y,c.width,c.height)},drawSnakeBody:function(){for(var a=1;a<this.snake.length()-1;a++){var b=this.snake.section(a);this.drawImage(E,F.animal_body_nian,this.getRect(b))}},drawSnakeTail:function(){var a=this.snake.section(0),b=this.snake.directionOfSection(0),c=F["animal_tail_"+b];this.drawImage(E,c,this.getRect(a))},drawSnakeHead:function(){var a=this.snake.section(-1),b=this.snake.directionOfSection(-1),c=F["animal_head_"+b];this.drawImage(E,c,this.getRect(a))},getRect:function(a){return{x:a.x*this.block_size,y:a.y*this.block_size,width:this.block_size,height:this.block_size}},drawFood:function(){var a=D[this.food.key],b=this.getRect(this.food);this.drawImage(C,a,b)},draw:function(){this.resetCanvas(),this.drawSnake(),this.drawFood()},changeSnakeDirection:function(a){this.snake.changeDirection(a)},getFood:function(){if(this.snake.sections.length===this.blocks*this.blocks)return null;var a=y.getFood(),b=this.getNewFoodPosition();return t.extend({},a,b,{score:a.score||z.DEFAULT_SCORE})},getNewFoodPosition:function(){var a={};do a.x=Math.floor(Math.random()*this.blocks),a.y=Math.floor(Math.random()*this.blocks);while(this.snake.onBody(a.x,a.y));return a}};var A={up:[38,75,87],down:[40,74,83],left:[37,65,72],right:[39,68,76]};f.prototype={show:function(){this.$el.removeClass("hide")},hide:function(){this.$el.addClass("hide")}},g.prototype={constructor:g,showGift:function(){this.$el.find(".courage-section").removeClass("hide")},setScore:function(a){this.$el.find(".score").html(a),a>=50?(this.$el.find(".tip-section .tips").html("<p>你竟然得了</p><p><span class='score'>"+a+"</span>分</p><p>年兽好满足，</p><p>暂时不会再来了！</p>"),this.$el.find(".nian-mood").removeClass("nian-sad").addClass("nian-happy")):(this.$el.find(".tip-section .tips").html("<p>你才得了</p><p><span class='score'>"+a+"</span>分</p><p>年兽还没吃饱，</p><p>还有可能出没哦！</p><p>继续加油吧！</p>"),this.$el.find(".nian-mood").removeClass("nian-happy").addClass("nian-sad"))},hideGift:function(){this.$el.find(".courage-section").addClass("hide")},onRestart:function(a){this.onRestartHandler=a},show:function(){this.$el.removeClass("hide")},hide:function(){this.$el.addClass("hide")}};var B={setupKeyBindings:function(){function a(a){return function(){b.game.status===d.PLAYING&&a&&a.apply(this,arguments)}}var b=this;$(document).on("keydown",a(function(a){a.preventDefault();var c=e(a.keyCode);c&&b.game.changeSnakeDirection(c)}));var c=$(document).hammer();c.on("touchmove",a(function(a){a.preventDefault()})).on("swipeup, dragup",a(function(a){a.preventDefault(),b.game.changeSnakeDirection("up")})).on("swipedow dragdown",a(function(a){a.preventDefault(),b.game.changeSnakeDirection("down")})).on("swipeleft dragleft",a(function(a){a.preventDefault(),b.game.changeSnakeDirection("left")})).on("swiperight dragright",a(function(a){a.preventDefault(),b.game.changeSnakeDirection("right")}))},onScoreChanged:function(){this.currentScoreEl.innerHTML=this.game.score()},onUploadScoreFailed:function(){var a=this;console.error("failed to upload score"),this.errorPane.show(),setTimeout(function(){a.errorPane.hide(),a.$overlay.hide()},2e3)},onScoreUploaded:function(a){this.showTotalScore(a.score),a.gift?this.gameoverPane.showGift():this.gameoverPane.hideGift(),this.gameoverPane.setScore(this.game.score()),this.gameoverPane.show()},onUploadScoreTimeout:function(){B.onUploadScoreFailed.call(this)},onGameFailed:function(){function a(a){return function(){b.loadingPane.hide(),a&&a.apply(null,arguments)}}var b=this;$(this.controlButton).removeClass("pause"),this.game.over(),this.$overlay.show(),this.loadingPane.show(),v.sync_score({score:this.game.score()},t.timeup(1e4,a(function(a,c){a?B.onUploadScoreFailed.call(b):B.onScoreUploaded.call(b,c)}),a(t.bind(B.onUploadScoreTimeout,this))))},newGame:function(){this.game=new d(this.canvas),this.game.onScoreChanged(t.bind(B.onScoreChanged,this)),this.game.onFailed(t.bind(B.onGameFailed,this))},kickOff:function(){this.currentScoreEl.innerHTML=0,this.rounds++},resume:function(){this.game.start(),$(this.controlButton).addClass("pause")},pause:function(){this.game.pause(),$(this.controlButton).removeClass("pause")},startGame:function(){B.newGame.call(this),B.kickOff.call(this),B.resume.call(this)}};h.prototype={onload:function(a){var b=this,c=$(".snake-loading-pane");return c.find("h1").hide(),v.isUserLogined()?(c.find("button").show().click(function(){c.hide(),"true"!==u.get("snake_played")?b.$rules.show():B.startGame.call(b)}),this.canvas=a,this.$overlay=$(".snake-modal-overlay"),this.loadingPane=new f($(".snake-modal-wrap.loading")[0]),this.errorPane=new f($(".snake-modal-wrap.error")[0]),this.gameoverPane=new g($(".gameover")[0]),this.gameoverPane.onRestart(function(){b.$overlay.hide(),b.gameoverPane.hide(),B.startGame.call(b)}),this.$rules=$(".snake-container-wrap .rules"),this.$rules.on("click","button",function(){u.set("snake_played","true",{expires:14}),b.$rules.hide(),B.startGame.call(b)}),this.currentScoreEl=document.getElementById("current-score"),this.totalScoreEl=document.getElementById("total-score"),this.controlButton=document.getElementById("control"),this.controlButton.onclick=function(){if(!b.game)return B.startGame.call(b);switch(b.game.status){case d.OVER:B.startGame.call(b);break;case d.PAUSED:B.resume.call(b);break;case d.PLAYING:B.pause.call(b);break;default:console.error("invlaid status",b.game.status)}},B.setupKeyBindings.call(this),v.info(function(a,c){if(!(b.rounds>1||b.game&&b.game.isOver())){if(a)return console.error(a);b.user=c,b.showTotalScore(b.user.score)}}),void 0):(c.find("button").show().click(function(){}),void 0)},showTotalScore:function(a){this.totalScoreEl.innerHTML=a}};var C=null,D=null,E=null,F=null,G=new h;$(function(){function a(a){var b="images/resources.png",c=new Image;c.onload=function(){a(null,c)},c.onerror=function(){a("fail to load image:"+b)},c.src=b}canvas=document.getElementById("snake"),canvas.getContext||G_vmlCanvasManager.initElement(canvas),async.parallel([i,j,a],function(a){return a?conosle.error(a):(G.onload(canvas),void 0)})})}();