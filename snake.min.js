/*! snake 2013-12-26 */
!function(){function a(a){setTimeout(a,0)}function b(a){var b=!1;return function(){b||(b=!0,a&&a.apply(this,arguments))}}function c(a){this.fps=4,this.tick=a,this.paused=!1}function d(a,b){this.direction=DIRECTION_LEFT,this.directionChanged=!1,this.bodyColor="#0F0",this.headColor="#08C",this.tailColor="#B20",this.blocks=a,this.x=Math.ceil(this.blocks/2),this.y=Math.ceil(this.blocks/2),this.sections=[];for(var c=this.x+b-1;c>=this.x;c--)this.sections.push({x:c,y:this.y})}function e(a){var b=this;this.canvas=a,this.context=this.canvas.getContext("2d"),this.blocks=e.BLOCKS,this.block_size=this.canvas.width/this.blocks,this.snake=new d(this.blocks,5),this.foods=[],this.food=this.getFood(),this.scoreListener=null,this.status=e.INITIALIZED,this.failListener=null,this.timer=new c(function(){return b.snake.move(),b.isCollision()?(b.timer.pause(),b.fail(),void 0):(b.snake.directionChanged=!1,b.snake.x==b.food.x&&b.snake.y==b.food.y?(b.foods.push(b.food),b.foods.length%5===0&&b.timer.speedUp(),b.scoreListener&&b.scoreListener(),b.food=b.getFood()):b.snake.sections.shift(),b.snake.sections.push({x:b.snake.x,y:b.snake.y}),i(function(){b.draw()}),void 0)})}function f(a){for(var b in t){var c=t[b];if(~r.indexOf(c,a))return b}return null}function g(){}function h(){var a={},b=[];r.each(r.keys(v.snake),function(a){b.push(v.snake[a])}),r.each(r.keys(v.foods),function(a){b.push(v.foods[a])});var c=0;return r.eachAsync(b,function(d,e){var f=new Image;f.onload=function(){d.img=f,c++,a.progress&&a.progress(c,b.length),e(null)},f.onerror=function(){s.log("fail to load img:",d.src),e("error")},f.src=d.src},function(b){b?a.fail&&a.fail(b):a.success&&a.success()}),a}var i=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||a,j=Array.prototype,k=Object.prototype,l=j.slice,m=j.indexOf,n=j.forEach,o=k.hasOwnProperty,p=Object.keys,q={},r={};r.has=function(a,b){return o.call(a,b)},r.keys=p||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[];for(var c in a)r.has(a,c)&&b.push(c);return b},r.indexOf=function(a,b){if(null===a)return-1;var c=0,d=a.length;if(m&&a.indexOf===m)return a.indexOf(b);for(;d>c;c++)if(a[c]===b)return c;return-1},r.each=function(a,b,c){if(null!==a)if(n&&a.forEach===n)a.forEach(b,c);else if(a.length===+a.length){for(var d=0,e=a.length;e>d;d++)if(b.call(c,a[d],d,a)===q)return}else for(var f=r.keys(a),d=0,e=f.length;e>d;d++)if(b.call(c,a[f[d]],f[d],a)===breaker)return},r.extend=function(a){return r.each(l.call(arguments,1),function(b){if(b)for(var c in b)a[c]=b[c]}),a},r.eachAsync=function(a,c,d){if(d=d||function(){},!a.length)return setTimeout(d,0);var e=0;r.each(a,function(f){c(f,b(function(b){b?(d(b),d=function(){}):(e+=1,e>=a.length&&d(null))}))})},r.bind=function(a,b){var c=l.call(arguments,2);return function(){a.apply(b,c.concat(l.call(arguments)))}};var s=s||{};s.log=s.log||function(){},s.error=s.error||function(){};c.prototype={constructor:c,start:function(){this.paused=!1,this.count()},count:function(){var a=this;setTimeout(function(){a.paused||(a.tick(),a.count())},1e3/this.fps)},pause:function(){this.paused=!0},speedUp:function(){this.fps<60&&this.fps++}},DIRECTION_LEFT="left",DIRECTION_RIGHT="right",DIRECTION_UP="up",DIRECTION_DOWN="down",INVERSE_DIRECTION={up:DIRECTION_DOWN,left:DIRECTION_RIGHT,right:DIRECTION_LEFT,down:DIRECTION_UP},d.prototype={changeDirection:function(a){this.directionChanged||a!==INVERSE_DIRECTION[this.direction]&&(this.direction=a,this.directionChanged=!0)},bumpSelf:function(){return this.onBody(this.x,this.y)},onBody:function(a,b){for(var c=0;c<this.sections.length;c++){var d=this.sections[c];if(d.x===a&&d.y===b)return!0}return!1},move:function(){switch(this.direction){case DIRECTION_UP:this.y--;break;case DIRECTION_DOWN:this.y++;break;case DIRECTION_LEFT:this.x--;break;case DIRECTION_RIGHT:default:this.x++}}},r.extend(e,{BLOCKS:20,INITIALIZED:"initialized",PLAYING:"playing",PAUSED:"paused",OVER:"over"}),e.prototype={contructor:e,start:function(){var a=this;return this.status!==e.INITIALIZED&&this.status!==e.PAUSED?(s.error("wrong status"),void 0):(this.status=e.PLAYING,this.timer.start(),i(function(){a.draw()}),void 0)},pause:function(){this.timer.pause(),this.status=e.PAUSED},fail:function(){this.status=e.OVER,this.failListener&&this.failListener()},onFailed:function(a){this.failListener=a},isCollision:function(){return this.snake.x<0||this.snake.x>=this.blocks||this.snake.y<0||this.snake.y>=this.blocks?!0:this.snake.bumpSelf()},resetCanvas:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},score:function(){var a=0;return r.each(this.foods,function(b){a+=b.score}),a},onScoreChanged:function(a){this.scoreListener=a},drawSnake:function(){for(var a=0;a<this.snake.sections.length;a++){var b=this.snake.sections[a];0===a?this.drawSnakeTail(b):a===this.snake.sections.length-1?this.drawSnakeHead(b):this.drawSnakeBody(b)}},drawImage:function(a,b){var c=this.context;c.drawImage(b,a.x*this.block_size,a.y*this.block_size,this.block_size,this.block_size)},drawSnakeBody:function(a){this.drawImage(a,v.snake.body.img)},drawSnakeTail:function(a){this.drawImage(a,v.snake.tail.img)},drawSnakeHead:function(a){this.drawImage(a,v.snake.head.img)},drawFood:function(){this.drawImage(this.food,this.food.img)},drawBox:function(a,b,c,d){var e=this.context;e.fillStyle=d,e.beginPath(),e.moveTo(a,b),e.lineTo(a+c,b),e.lineTo(a+c,b+c),e.lineTo(a,b+c),e.closePath(),e.fill()},draw:function(){this.resetCanvas(),this.drawFood(),this.drawSnake()},changeSnakeDirection:function(a){this.snake.changeDirection(a)},getFood:function(){var a,b,c=w.getFood();do a=Math.floor(Math.random()*this.blocks),b=Math.floor(Math.random()*this.blocks);while(this.snake.onBody(a,b));var c=r.extend({},c,{x:a,y:b});return c}};var t={up:[38,75,87],down:[40,74,83],left:[37,65,72],right:[39,68,76]},u={setupKeyBindings:function(){function a(a){return function(){b.game.status===e.PLAYING&&a&&a.apply(this,arguments)}}var b=this;$(document).on("keydown",a(function(a){var c=f(a.keyCode);c&&b.game.changeSnakeDirection(c)}));var c=$(document).hammer();c.on("touchmove",a(function(a){a.preventDefault()})).on("swipeup, dragup",a(function(a){a.preventDefault(),b.game.changeSnakeDirection("up")})).on("swipedow dragdown",a(function(a){a.preventDefault(),b.game.changeSnakeDirection("down")})).on("swipeleft dragleft",a(function(a){a.preventDefault(),b.game.changeSnakeDirection("left")})).on("swiperight dragright",a(function(a){a.preventDefault(),b.game.changeSnakeDirection("right")}))},onScoreChanged:function(){this.currentScoreEl.innerHTML=this.game.score()},onGameFailed:function(){this.controlButton.innerHTML="开始",this.game=new e(this.canvas),this.game.onScoreChanged(r.bind(u.onScoreChanged,this)),this.game.onFailed(r.bind(u.onGameFailed,this))}};g.prototype={onload:function(a){var b=this;this.canvas=a,this.game=new e(this.canvas),this.currentScoreEl=document.getElementById("current-score"),this.controlButton=document.getElementById("control"),this.controlButton.onclick=function(){switch(b.game.status){case e.INITIALIZED:case e.OVER:case e.PAUSED:b.game.start(),this.innerHTML="暂停";break;case e.PLAYING:default:b.game.pause(),this.innerHTML="继续"}},u.setupKeyBindings.call(this),this.game.onScoreChanged(r.bind(u.onScoreChanged,this)),this.game.onFailed(r.bind(u.onGameFailed,this))}};var v={snake:{head:{src:"images/Festive-icon.png"},tail:{src:"images/Snowy-icon.png"},body:{src:"images/Wreath-icon.png"}},foods:{food1:{score:1,name:"中粮食品",src:"images/Wreath-icon.png"}}},w={getFood:function(){var a=r.keys(v.foods);if(0===a.length)return null;var b=Math.floor(Math.random()*a.length);return v.foods[a[b]]}},x=new g;$(function(){canvas=document.getElementById("snake"),canvas.getContext||G_vmlCanvasManager.initElement(canvas);var a=h();a.success=r.bind(x.onload,x,canvas),a.progress=function(a,b){s.log("progress:",a,b)},a.fail=function(a){s.error(a)}})}();